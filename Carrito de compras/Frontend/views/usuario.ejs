<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informaci√≥n de Usuario</title>
    <link rel="stylesheet" href="../css/usuario.css">
</head>
<body>
    <div class="topbar">
        <div class="topbar-left">
            <a href="#" class="cart-container" onclick="verificarSesionCarrito(event)">
                <img src="/img/Carritoicono.png" alt="Carrito" class="cart-icon" id="cart-icon">
            </a>
        </div>
        <div class="topbar-center">
            <a href="/principal" class="brand-title">QUESOS BABYBEL</a>
        </div>
        <div class="topbar-right">
            <a href="/principal" class="user-circle">U</a>
        </div>
    </div>

    <div class="contenedor">
        <h2>Informaci√≥n del Usuario</h2>

        <div class="campo">
            <label>Nombre:</label>
            <div class="cuadro"><%= typeof user !== 'undefined' ? user.nombre : 'Usuario' %></div>
        </div>

        <div class="campo">
            <label>Correo:</label>
            <div class="cuadro"><%= typeof user !== 'undefined' ? user.email : 'usuario@email.com' %></div>
        </div>

        <a href="/cambContra">Cambiar Contrase√±a</a>
        <a href="/cambCorreo">Cambiar Correo</a>
        <a href="/principal">Regresar</a>
        <button onclick="cerrarSesion()" class="btn-cerrar-sesion">Cerrar Sesi√≥n</button>
        <button onclick="eliminarCuenta()" class="btn-eliminar">Eliminar Cuenta</button>
    </div>

    <script>
        // Cargar datos del usuario desde localStorage
        window.addEventListener('DOMContentLoaded', function() {
            // Primero intentar con datos del servidor
            const usuarioServidor = {
                nombre: '<%= typeof user !== "undefined" ? user.nombre : "" %>',
                email: '<%= typeof user !== "undefined" ? user.email : "" %>',
                id: '<%= typeof user !== "undefined" ? user.id : "" %>'
            };

            // Si hay datos del servidor, actualizar localStorage
            if (usuarioServidor.nombre && usuarioServidor.email) {
                localStorage.setItem('usuario', JSON.stringify(usuarioServidor));
                localStorage.setItem('usuarioNombre', usuarioServidor.nombre);
                localStorage.setItem('usuarioEmail', usuarioServidor.email);
                localStorage.setItem('usuarioId', usuarioServidor.id);
                
                document.querySelectorAll('.cuadro')[0].textContent = usuarioServidor.nombre;
                document.querySelectorAll('.cuadro')[1].textContent = usuarioServidor.email;
            } else {
                // Si no hay datos del servidor, usar localStorage
                const usuario = JSON.parse(localStorage.getItem('usuario'));
                if (usuario) {
                    document.querySelectorAll('.cuadro')[0].textContent = usuario.nombre;
                    document.querySelectorAll('.cuadro')[1].textContent = usuario.email;
                } else {
                    // Si no hay datos en ning√∫n lado, redirigir al login
                    window.location.href = '/login';
                }
            }
        });

        function cerrarSesion() {
            // Obtener datos del usuario actual
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            const usuarioId = usuario ? usuario.id : localStorage.getItem('usuarioId');
            
            // Guardar el carrito actual asociado al usuario
            const carritoActual = localStorage.getItem('carrito');
            if (carritoActual && usuarioId) {
                localStorage.setItem(`carrito_usuario_${usuarioId}`, carritoActual);
            }
            
            // Limpiar datos de sesi√≥n
            localStorage.removeItem('usuario');
            localStorage.removeItem('usuarioNombre');
            localStorage.removeItem('usuarioEmail');
            localStorage.removeItem('usuarioId');
            localStorage.removeItem('carrito');
            
            // Redirigir al login y prevenir regreso
            alert('Sesi√≥n cerrada exitosamente. Tu carrito se ha guardado.');
            window.location.replace('/principal');
            // Prevenir navegaci√≥n hacia atr√°s
            history.pushState(null, null, location.href);
            window.onpopstate = function() {
                history.go(1);
            };
        }

        function eliminarCuenta() {
            if (!usuario || !usuario.id) {
                alert('No hay sesi√≥n activa');
                window.location.href = '/login';
                return;
            }

            // Primera confirmaci√≥n
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar tu cuenta?\n\nEsta acci√≥n eliminar√° permanentemente:\n‚Ä¢ Tus datos personales\n‚Ä¢ Tu historial de compras\n‚Ä¢ Tu carrito guardado\n\n¬øDeseas continuar?')) {
                // Segunda confirmaci√≥n
                if (confirm('üö® √öLTIMA CONFIRMACI√ìN\n\n¬øRealmente deseas eliminar tu cuenta de forma PERMANENTE?\n\nEsta acci√≥n NO SE PUEDE DESHACER.')) {
                    // Guardar carrito actual antes de eliminar
                    const usuarioId = usuario.id;
                    const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
                    localStorage.setItem(`carrito_usuario_${usuarioId}`, JSON.stringify(carrito));

                    // Enviar solicitud para eliminar cuenta
                    fetch('/eliminar-cuenta', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: usuario.id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Limpiar localStorage de sesi√≥n actual
                            localStorage.removeItem('usuario');
                            localStorage.removeItem('usuarioNombre');
                            localStorage.removeItem('usuarioEmail');
                            localStorage.removeItem('usuarioId');
                            localStorage.removeItem('carrito');
                            localStorage.removeItem('carritoActual');
                            localStorage.removeItem('totalActual');
                            localStorage.removeItem('carritoComprado');
                            localStorage.removeItem('totalCompra');
                            localStorage.removeItem(`carrito_usuario_${usuarioId}`);
                            
                            alert('‚úì Tu cuenta ha sido eliminada exitosamente.\n\nTodos tus datos han sido borrados del sistema.');
                            window.location.replace('/principal');
                            // Prevenir navegaci√≥n hacia atr√°s
                            history.pushState(null, null, location.href);
                            window.onpopstate = function() {
                                history.go(1);
                            };
                        } else {
                            alert('‚ùå Error al eliminar la cuenta: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('‚ùå Error al eliminar la cuenta. Por favor intenta de nuevo.');
                    });
                } else {
                    alert('Eliminaci√≥n de cuenta cancelada. Tu cuenta se mantiene activa.');
                }
            } else {
                alert('Eliminaci√≥n de cuenta cancelada.');
            }
        }

        // Funci√≥n para actualizar el √≠cono del carrito
        function actualizarIconoCarrito() {
            const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
            const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            const cartIcon = document.getElementById('cart-icon');
            
            if (cartIcon) {
                if (totalItems > 0) {
                    cartIcon.src = '/img/carritolleno.png';
                    cartIcon.alt = 'Carrito Cargado';
                } else {
                    cartIcon.src = '/img/Carritoicono.png';
                    cartIcon.alt = 'Carrito Vac√≠o';
                }
            }
        }

        // Funci√≥n para verificar sesi√≥n antes de ir al carrito
        function verificarSesionCarrito(event) {
            event.preventDefault();
            const usuarioNombre = localStorage.getItem('usuarioNombre');
            
            if (!usuarioNombre) {
                alert('Primero tienes que iniciar sesi√≥n para ver el carrito');
                return;
            }
            
            window.location.href = '/carrito';
        }

        // Actualizar √≠cono al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            actualizarIconoCarrito();
        });
    </script>
</body>
</html>